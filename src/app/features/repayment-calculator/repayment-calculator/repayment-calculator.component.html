<div class="container my-4">
  <h2 class="mb-3 text-white" i18n>Calculator de rambursare anticipată</h2>
  <p class="text-white-50 mb-4" i18n>Calculează cât economisești la dobândă atunci când rambursezi creditul mai devreme.</p>
 
  <!-- Scenario mode toggles -->
  <div class="row my-4">
    <div class="col-md-4">
      <label class="form-label" i18n>Mod:</label>
      <mat-button-toggle-group [(ngModel)]="mode" (ngModelChange)="onModeChanged($event)" class="schedule-toggle-group ms-3">
        <mat-button-toggle value="simple" i18n>Simplu</mat-button-toggle>
        <mat-button-toggle value="advanced" i18n>Avansat</mat-button-toggle>
      </mat-button-toggle-group>  
    </div>
    <div class="col-md-6">
      <label class="form-label" i18n>Tip credit:</label> 
      <mat-button-toggle-group [(ngModel)]="loanType" (ngModelChange)="onLoanTypeChanged($event)" class="schedule-toggle-group ms-3">
        <mat-button-toggle value="annuity" i18n>Rate egale</mat-button-toggle>
        <mat-button-toggle value="linear" i18n>Rate descrescătoare</mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </div>

  <!-- Input area -->
  <ng-container [ngSwitch]="mode">
    <!-- Simple mode reuses existing component -->
    <app-loan-input
      *ngSwitchCase="'simple'"
      [(amount)]="amount"
      [(period)]="totalPeriod"
      [(rate)]="fixedRate"
      [(insuranceRate)]="insuranceRate"
      [isScheduleVisible]="false"
      (inputChanged)="onSimpleInputChanged($event)">
    </app-loan-input>

    <!-- Advanced mode uses new component -->
    <app-advanced-loan-input
      *ngSwitchCase="'advanced'"
      [(amount)]="amount"
      [(totalPeriod)]="totalPeriod"
      [(fixedMonths)]="fixedMonths"
      [(fixedRate)]="fixedRate"
      [(variableRate)]="variableRate"
      [(insuranceRate)]="insuranceRate"
      [isScheduleVisible]="false"
      (inputChanged)="onAdvancedInputChanged($event)">
    </app-advanced-loan-input>
  </ng-container>

  <div class="row mt-4">
    <mat-accordion>
      <mat-expansion-panel expanded="true">
      <!-- Header of the collapsible section -->
        <mat-expansion-panel-header>
          <mat-panel-title i18n>
          Sumă rambursată: {{ earlyRepaymentAmount ? (earlyRepaymentAmount | formatCurrency) : '–' }}
        </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="row align-items-end g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label text-white" i18n>
              Suma rambursată anticipat:
            </label>
            <input
              type="number"
              class="form-control"
              min="0"
              step="100"
              [(ngModel)]="earlyRepaymentAmount"
              (ngModelChange)="onEarlyRepaymentAmountChange($event)"
              placeholder="Ex: 10 000"
            />
          </div>

          <div class="col-md-5">
            <label class="form-label text-white" i18n>
              Cum aplici rambursarea:
            </label>
            <mat-button-toggle-group
              [(ngModel)]="repaymentEffect"
              (ngModelChange)="onRepaymentEffectChange($event)"
              class="schedule-toggle-group ms-1"
            >
              <mat-button-toggle value="period" i18n>
                Reduce perioada
              </mat-button-toggle>
              <mat-button-toggle value="amount" i18n>
                Reduce rata lunară
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <div class="col-md-12 mt-2" *ngIf="earlyRepaymentAmount !== null && earlyRepaymentAmount > 0">
            <p class="text-white-50 mb-0" *ngIf="repaymentEffect === 'period'" i18n>
              Vei reduce perioada creditului cu {{ reducedMonths }} luni. Vei economisi aproximativ {{ totalSaved | formatCurrency}} (dobândă + asigurare).
            </p>
            <p class="text-white-50 mb-0" *ngIf="repaymentEffect === 'amount'" i18n>
              Rata lunară va fi cu aproximativ {{diffInstallment | formatCurrency}} mai mică. Vei economisi aproximativ {{ totalSaved | formatCurrency}} (dobândă + asigurare).
            </p>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>

  <!-- Summaries: original vs after repayment -->
  <div class="row">
    <div class="col-12 col-md-6 mb-3 mt-5" *ngIf="baseSchedule.length">
      <h5 class="text-white mb-2" i18n>Înainte de rambursare</h5>
      <app-payment-summary-cards
        [firstPayment]="baseFirstPayment"
        [isAnnuityPayment]="loanType === 'annuity' ? true : false"
        [total]="baseTotal"
        [amount]="amount"
        [interestTotal]="baseInterestTotal"
        [insuranceTotal]="baseInsuranceTotal"
        [IsInsuranceRateEnabled]="insuranceRate !== null"
        [isSavingBadgeVisible]="false"
        [alertClass]="'alert-green'"
      ></app-payment-summary-cards>
    </div>

    <div class="col-md-6 mb-3 mt-5" *ngIf="isValid() && earlyRepaymentAmount !== null">
      <h5 class="text-white mb-2" i18n>După rambursare</h5>
      <app-payment-summary-cards *ngIf="newSchedule.length"
        [firstPayment]="newFirstPayment"
        [isAnnuityPayment]="loanType === 'annuity' ? true : false"
        [total]="newTotal"
        [amount]="amount"
        [interestTotal]="newInterestTotal"
        [insuranceTotal]="newInsuranceTotal"
        [IsInsuranceRateEnabled]="insuranceRate !== null"
        [isSavingBadgeVisible]="true"
        [savingAmount]="totalSaved"
        [alertClass]="'alert-purple'"
      ></app-payment-summary-cards>
      <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;" *ngIf="isValid() &&  earlyRepaymentAmount !== null && earlyRepaymentAmount >= amount!">
        <div class="feature-card">
          <div class="feature-header mx-auto">
            <span class="feature-card-icon"><i class="bi bi-house-heart"></i></span>
            <span class="feature-title" i18n>Felicitări!</span>
          </div>
          <div class="feature-description mx-auto" i18n>
            Ai rambursat creditul tău!
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Amortization schedules: original vs after repayment -->
  <div class="row mt-5">
    <div class="col-lg-6 mb-4 mt-3" *ngIf="baseSchedule.length">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-white" i18n>Scadențar înainte de rambursare</h4>
        <button type="button" class="btn btn-outline-primary btn-sm" (click)="downloadOriginalSchedulePdf()">
          <span class="me-2">PDF</span>
          <i class="bi bi-download"></i>
        </button>
      </div>
      <app-amortization-schedule
        [schedule]="baseSchedule"
        [insuranceRate]="insuranceRate"
      ></app-amortization-schedule>
    </div>

    <div class="col-lg-6 mb-4 mt-3" *ngIf="newSchedule.length">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-white" i18n>Scadențar după rambursare</h4>
        <button type="button" class="btn btn-outline-primary btn-sm" (click)="downloadAfterRepaymentSchedulePdf()">
          <span class="me-2">PDF</span>
          <i class="bi bi-download"></i>
        </button>
      </div>
      <app-amortization-schedule
        [schedule]="newSchedule"
        [insuranceRate]="insuranceRate"
      ></app-amortization-schedule>
    </div>
</div>
